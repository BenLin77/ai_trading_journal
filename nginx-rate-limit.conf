# Nginx Rate Limiting Configuration
# 安全措施 #2 & #8: Rate Limit 與成本控制
#
# 使用方式：
# 1. 將此檔案加入到 nginx.conf 的 http 區塊：
#    sudo nano /etc/nginx/nginx.conf
#    在 http { } 區塊中加入：
#    include /root/ai_trading_journal/nginx-rate-limit.conf;
#
# 2. 重新載入 Nginx：
#    sudo nginx -t && sudo systemctl reload nginx

# ========== Rate Limiting Zones ==========

# API 請求限制：每秒 10 個請求
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# AI 相關 API 請求限制：每分鐘 30 個請求（防止濫用 AI 功能）
limit_req_zone $binary_remote_addr zone=ai_limit:10m rate=30r/m;

# 一般頁面請求限制：每秒 20 個請求
limit_req_zone $binary_remote_addr zone=page_limit:10m rate=20r/s;

# 登入/認證相關：每分鐘 5 次（防止暴力破解）
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/m;

# ========== Connection Limiting ==========

# 每個 IP 最多 10 個並發連線
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ========== 回應設定 ==========

# 超過限制時返回 429 Too Many Requests
limit_req_status 429;
limit_conn_status 429;

# 自訂 429 錯誤頁面（可選）
# error_page 429 /429.html;
